# Fix Clean Archive Bypass: Extract All Archives Regardless of Malware Detection

## Problem

Archives without malware patterns are never extracted. The extraction logic is encapsulated inside the `if (hasGarbage)` block, causing clean archives to be skipped entirely.

**Location**: `file:src/lib/cleanup.ts` (Lines 221-327)

**Current Flow**:
```typescript
if (hasGarbage) {
  // Extract files, scan nested archives, apply policy
  return { flagged: true, extractedCount };
}
return { flagged: false, extractedCount: 0 }; // Clean archives skip extraction!
```

**Impact**:
- Clean archives remain compressed
- Users must manually extract them
- Violates requirement: "the app should be properly creating the folder structure and extracting them"

## Solution

Decouple extraction from malware detection. Always extract `KEEP_EXTS` files, then scan and apply policy.

### Implementation Steps

1. **Move extraction outside `hasGarbage` check**:
   ```typescript
   async function cleanArchive(...) {
     // 1. ALWAYS extract KEEP_EXTS files
     const extractedFiles = await extractAllKeepFiles(archivePath, stagingDir, dirPath);
     
     // 2. Scan for malware (in archive listing AND extracted files)
     const hasGarbage = detectMalware(internalListing, extractedFiles);
     
     // 3. Apply policy based on malware detection
     if (hasGarbage) {
       await handleMaliciousArchive(archivePath, policy, stats);
     } else {
       await handleCleanArchive(archivePath, policy, stats);
     }
     
     return { flagged: hasGarbage, extractedCount: extractedFiles.length };
   }
   ```

2. **Create extraction helper**:
   ```typescript
   async function extractAllKeepFiles(
     archivePath: string,
     stagingDir: string,
     targetDir: string
   ): Promise<string[]> {
     const extractedFiles: string[] = [];
     const engine = getEngine();
     if (!engine) return extractedFiles;
     
     for (const ext of KEEP_EXTS) {
       // Extract with structure preservation
       const extractCmd = engine.type === "7z"
         ? [engine.bin, "x", archivePath, `*${ext}`, `-o${stagingDir}`, "-r", "-y"]
         : [engine.bin, "x", "-r", "-y", archivePath, `*${ext}`, stagingDir];
       
       const spawnRes = getSpawnSync()(extractCmd);
       if (spawnRes.success) {
         const matches = await glob(`**/*${ext}`, { cwd: stagingDir, absolute: true });
         for (const match of matches) {
           const relPath = relative(stagingDir, match);
           const destPath = join(targetDir, relPath); // Structure preservation
           const destDir = dirname(destPath);
           if (!existsSync(destDir)) mkdirSync(destDir, { recursive: true });
           
           renameSync(match, destPath);
           extractedFiles.push(relative(targetDir, destPath));
         }
       }
     }
     
     return extractedFiles;
   }
   ```

3. **Handle clean archives**:
   ```typescript
   async function handleCleanArchive(
     archivePath: string,
     policy: "purge" | "isolate" | "extract",
     stats: CleanupStats
   ) {
     if (policy === "purge" || policy === "extract") {
       unlinkSync(archivePath);
       stats.purgedFiles++;
       Logger.info("SHIELD", `Deleted clean archive: ${archivePath}`);
     }
     // Note: "isolate" policy doesn't move clean archives
   }
   ```

### Acceptance Criteria

- [ ] Clean archives (no malware) are extracted automatically
- [ ] Extracted files maintain folder structure (see related ticket)
- [ ] Archive lifecycle follows policy even for clean archives
- [ ] Nested archives within clean archives are processed recursively
- [ ] Stats correctly track `extractedFiles` for clean archives
- [ ] Existing malware detection logic unchanged
- [ ] New test added: `tests/cleanup.test.ts` - "extracts clean archives"

### Test Case

```typescript
// Clean archive with no malware patterns
// archive.zip
//   └── schematic.pdf

// Expected behavior:
// 1. Extract schematic.pdf
// 2. Delete archive.zip (if policy is "purge")
// 3. Return { flagged: false, extractedCount: 1 }
```

### Files to Modify

- `file:src/lib/cleanup.ts` (Lines 147-328) - Refactor `cleanArchive()`
- `file:tests/cleanup.test.ts` (Add clean archive extraction test)

### Dependencies

This ticket should be implemented **after** the folder flattening fix to ensure clean archives are extracted with proper structure.
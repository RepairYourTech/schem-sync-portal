# Add "Extract" Policy: Support Extraction Without Malware Isolation

## Problem

The current system only supports two policies: `purge` and `isolate`. There's no option to extract all files and simply delete archives without malware scanning/isolation.

**Current Limitation**:
- Users who trust their source completely still have files isolated/purged
- No way to disable malware handling while keeping extraction

**Requirement**: Support a "trust source" mode where archives are extracted and deleted without malware processing.

## Solution

Add a third policy option: `extract` - Extract all files, delete archives, skip malware isolation.

### Implementation Steps

1. **Update config type** in `file:src/lib/config.ts`:
   ```typescript
   export interface PortalConfig {
     // ...
     malware_policy: "purge" | "isolate" | "extract";
   }
   ```

2. **Update default config**:
   ```typescript
   export const EMPTY_CONFIG: PortalConfig = {
     // ...
     malware_policy: "purge", // Keep existing default
   };
   ```

3. **Add migration logic** in `loadConfig()`:
   ```typescript
   // Migrate old enable_malware_shield boolean to new policy
   if (parsed.enable_malware_shield === false && !parsed.malware_policy) {
     parsed.malware_policy = "extract"; // Shield disabled = extract all
   } else if (!parsed.malware_policy) {
     parsed.malware_policy = "purge"; // Default
   }
   ```

4. **Update cleanup logic** in `file:src/lib/cleanup.ts`:
   ```typescript
   async function cleanArchive(..., policy: "purge" | "isolate" | "extract") {
     // ... extraction logic ...
     
     if (policy === "extract") {
       // Extract all files (including potential malware)
       // Only delete the archive
       unlinkSync(archivePath);
       stats.purgedFiles++;
       Logger.info("SHIELD", `Extract policy: Deleted archive ${relPath}`);
       return { flagged: false, extractedCount };
     }
     
     // Existing purge/isolate logic for malware handling
     if (hasGarbage) {
       // ... existing malware handling ...
     }
   }
   ```

5. **Update UI** in `file:src/components/wizard/steps/SecurityStep.tsx`:
   ```typescript
   // Three radio options:
   // 1. Purge (Recommended) - Extract schematics, delete archives and malware
   // 2. Isolate (Forensic) - Extract schematics, quarantine archives with malware
   // 3. Extract All (Trust Source) - Extract everything, delete archives only
   ```

6. **Update type definitions** in `file:src/lib/sync/types.ts`:
   ```typescript
   export interface CleanupStats {
     // ...
     policyMode: "purge" | "isolate" | "extract";
   }
   ```

### Acceptance Criteria

- [ ] Config accepts `malware_policy: "extract"`
- [ ] Migration converts `enable_malware_shield: false` to `malware_policy: "extract"`
- [ ] Extract policy skips malware detection/isolation
- [ ] Extract policy deletes archives after extraction
- [ ] Extract policy extracts ALL files (not just KEEP_EXTS)
- [ ] UI shows three policy options with clear descriptions
- [ ] Existing purge/isolate policies unchanged
- [ ] New test added: `tests/cleanup.test.ts` - "extract policy extracts all files"

### Test Case

```typescript
// Archive with malware pattern:
// archive.zip
//   ├── schematic.pdf
//   └── crack.exe

// With policy="extract":
// 1. Extract schematic.pdf
// 2. Extract crack.exe (no isolation)
// 3. Delete archive.zip
// 4. Return { flagged: false, extractedCount: 2 }

// With policy="purge":
// 1. Extract schematic.pdf
// 2. Delete crack.exe
// 3. Delete archive.zip
// 4. Return { flagged: true, extractedCount: 1 }
```

### Files to Modify

- `file:src/lib/config.ts` (Type definition, migration)
- `file:src/lib/cleanup.ts` (Policy handling)
- `file:src/lib/sync/types.ts` (Type definitions)
- `file:src/components/wizard/steps/SecurityStep.tsx` (UI)
- `file:tests/cleanup.test.ts` (Add extract policy test)

### UI Copy

**Purge (Recommended)**
- Extracts schematics and boardviews
- Deletes malware and archives
- Saves disk space

**Isolate (Forensic)**
- Extracts schematics and boardviews
- Moves malware to `_risk_tools/` for analysis
- Keeps archives for investigation

**Extract All (Trust Source)**
- Extracts all files without filtering
- Deletes archives only
- Use when source is completely trusted